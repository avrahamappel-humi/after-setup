#!/bin/bash

applications="$HOME/humility/applications/*"

# MacOS doesn't include realpath, until Ventura
here=$(dirname $(readlink -f $0 ))

# Add githooks
for p in $applications
do
    if ! test -d "$p/.git"
    then
        continue
    fi

    ln -s -f "$here/prepare-commit-msg" "$p/.git/hooks/prepare-commit-msg"
done

# Add Nix shells
for p in $applications
do
    shell="$here/shells/$(basename $p).nix"

    if test -f $shell
    then
        echo "Installing nix shell in $p"

        # Symbolic link so we can continue editing
        rm -f "$p/shell.nix"
        ln -s -f $shell "$p/shell.nix"
        echo shell.nix >> "$p/.git/info/exclude"
    fi

    # Sometimes there already is a shell.nix in the repo
    if test -n "$(find $p -maxdepth 1 -name '*.nix' -print -quit)"
    then
        echo "Setting up direnv to use the nix shell"

        if test -f flake.nix
        then
            echo use flake > "$p/.envrc"
        else
            echo use nix > "$p/.envrc"
        fi

        cat >> "$p/.git/info/exclude" << EOF
.direnv/
.envrc
EOF
        direnv allow $p 
    fi

    if test "$(basename $p)" == "payroll"
    then
        # This will cause gems to be installed in the .direnv directory
        echo 'layout ruby' >> "$p/.envrc"

        ln -s -f "$here/solargraph.yml" "$p/.solargraph.yml"

        cat >> "$p/.git/info/exclude" << EOF
.solargraph.yml
app/rails.rb
EOF

        # Install gems and set up Solargraph
        (
            cd $p
            direnv exec $p bundle install
            direnv exec $p solargraph download-core
            direnv exec $p solargraph bundle
            cd "$p/app"
            nix-shell -p wget --run "wget 'https://gist.githubusercontent.com/castwide/28b349566a223dfb439a337aea29713e/raw/715473535f11cf3eeb9216d64d01feac2ea37ac0/rails.rb'"
        )
    fi
done
